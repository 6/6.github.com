<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>Arrow Key Game</title>
<link rel="stylesheet" type="text/css" href="game.css"> 
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script src="jquery.color.js"></script>
</head>
<body>
<div class="wrap">
    <div id="bonus" class="left center-align">
        <img id="smile0" src="0.png" class="smile">
        <!-- preload these other images -->
        <img id="smile1" src="1.png" class="hidden smile">
        <img id="smile2" src="2.png" class="hidden smile">
    </div>
    <div id="game" class="center-align left">
        <div id="prompt" class="bold bigger">Loading...</div><!--prompt-->
        <br><h2 class="smaller grey center-align">Possible answers:</h2>
        <div id="answerNumber0" class="bold answer medium left">Loading...</div><!--left--> 
        <div id="answerNumber2" class="bold answer medium">Loading...</div><!--right--> 
        <div class="control left"><span id="leftarrow" class="keyboardKey">&larr;</span> Left arrow</div><div class="control right right-align">Right arrow <span id="rightarrow" class="keyboardKey">&rarr;</span></div>
        <div class="clear">&nbsp;</div>
        <div id="statusbar" class="left-align round"><div id="currentstatus" class="round"></div></div>
    </div>
    <div id="sidebar" class="medium center-align">
         <div id="scoreSection" class="section"><span class="smaller">Time</span><br><span id=timer class="medium"></span><br>
        <div id="scoreSection" class="section"><span class="smaller">Score</span><br><span id=score class="bigger"></span><br><span id="scoreChange" class="medium"></span></div>
        <div id="messages" class="section bold"></div>
        <div id="playAgain" class="hidden section"><a id="playAgainButton" href="#playAgain">Play Again</a></div>
    </div>
</div>
<!--br class="clear"><br><br><br><hr><br>
Edit game data (must be valid JSON):<br-->
<textarea id="data" class="hidden">[{"type":"text","prompt":"amarillo","answer":"yellow"},{"type":"text","prompt":"gris","answer":"grey"},{"type":"text","prompt":"anaranjado","answer":"orange"},{"type":"text","prompt":"dorado","answer":"golden"},{"type":"text","prompt":"blanco","answer":"white"},{"type":"text","prompt":"azul","answer":"blue"},{"type":"text","prompt":"turquesa","answer":"turqoise"},{"type":"text","prompt":"plateado","answer":"silver"}]</textarea><br>
<!--button id="submitData">Submit New Data &rarr;</button-->

<script type="text/javascript">
// JSON data for questions/answers
var data;

// user's score
var score;

// how many bonus points to add to score
var scoreBonus;

// current question and answer
var curQA;

// correct question and answer index
var correctQAIdx;

// array of the correct questions and answers
var correctQAIdxs;

// default background color of answers
var defaultBg;

// boolean, keep user from answering during background fade
var alreadyAnswered;

// boolean, whether or not arrow keys for game control are disabled
var arrowKeysDisabled;

// boolean, previous answer is correct 
var previousCorrect;

// boolean, whether or not game timer has started
var timerStarted;

// seconds used for current game
var timerSeconds;

// the timer used to tracking seconds
var timer;

// highscore starts at 0
var highscore = 0;

// best time starts at inf
var besttime = Infinity;

$(document).ready(function(){
    
    // get the default background color
    defaultBg = $(".answer").css("background-color");
    
    // check answer on key down
    $("body").keydown(function(e) {
        onKey(e.keyCode);
    }).keyup(function(){
        $(".keyboardKey").removeClass("pressed");
    });
    
    // start new game when play again button clicked
    $("#playAgainButton").click(function() {
        startNewGame();
        return !1;
    });
    
    // temporarily disable arrow key game functionality to allow editing
    $("#data").focus(function () {
        arrowKeysDisabled = true;
    }).focusout(function () {
        arrowKeysDisabled = false;
    });
    
    // submit new JSON data for the game
    $("#submitData").click(function() {
        parseData();
        startNewGame();
        return !1;
    });
    
    // start the first game
    parseData();
    startNewGame();
});

// initialize (or reset) the game
function startNewGame(){
    arrowKeysDisabled = false;
    previousCorrect = false;
    timerStarted = false;
    
    //reset score, bonus, and timer seconds
    score = 0;
    scoreBonus = 0;
    $("#score").text(score); 
    timerSeconds = 0;
    $("#timer").text(timerSeconds);
    
    // hide the Play Again button
    $("#playAgain").hide(200);
    
    // remove any messages
    $("#messages").html("");
    
    // reset correct answer idxs
    correctQAIdxs = new Array();
    
    // reset status bar
    updateStatusBar();
    
    showNextQA();
}

// parse JSON data in textarea
function parseData() {
    try {
        data = jQuery.parseJSON($('#data').val()); 
    } catch(e) {
        alert("Invalid JSON");
    }
}

/*
If keyCode represents a control (right or left key) then check answer for
correctness and change score and animate the answer to indicate correctness.
*/
function onKey(keyCode) {
    if(alreadyAnswered || arrowKeysDisabled || (keyCode != 37 && keyCode != 39)) {
        // not left or right arrow key codes or answered or disabled, so ignore
        return;
    }
    if(keyCode == 37) {
        // press left arrow
        $("#leftarrow").addClass("pressed");
    }
    else {
        // press right arrow
        $("#rightarrow").addClass("pressed");
    }
    // start the timer if it hasn't started yet
    if(!timerStarted) {
        timerStarted = true;
        timer = setInterval("updateTimer()",100);
    }
    alreadyAnswered = true;
    
    // check answer for correctness
    var answerId = "#answerNumber"+(keyCode-37);
    // TODO: change to make this work on images using $(id).hasClass("img")
    
    $(".smile").hide(0);
    
    // figure out amount to change score by and new background color
    var scoreChange = 0;
    var newBg;
    var isCorrect;
    if($(answerId).text() == data[correctQAIdx].answer) {
        // correct
        scoreChange += 1+scoreBonus;
        scoreBonus = (scoreBonus+1)* 2;
        correctQAIdxs.push(correctQAIdx);
        newBg = "#afa";
        if(previousCorrect && genRandom(4) == 4) {
            // random extra bonus
            $("#smile2").show(0);
        }
        else{
            // regular smiley face
            $("#smile1").show(0);
        }
        isCorrect = true;
        previousCorrect = true;
        updateStatusBar();
    }
    else {
        // incorrect
        scoreChange -= 1;
        scoreBonus = 0;
        newBg = "#faa";
        isCorrect = false;
        previousCorrect = false;
        // meh smiley face
        $("#smile0").show(0);
    }
    
    changeScore(scoreChange);
    showScoreChange(scoreChange, isCorrect);
    
    // momentarily fade the color to indicate right/wrong answer
    $(answerId).animate({
        backgroundColor:newBg
    }, 150, function() {
        setTimeout("onAnswerIndicatorFinish()", 500);
    });
}

//When the correct/incorrect answer indicator finishes animating
function onAnswerIndicatorFinish() {
    $(".answer").css("background-color",defaultBg);
    if(!isWin()) {
        showNextQA();
    }
}

// show the next question-answers
function showNextQA() {
    alreadyAnswered = false;
    
    // update the prompt with a random prompt
    correctQAIdx = genRandomNotIn(correctQAIdxs,data.length-1);
    var curQA = data[correctQAIdx];
    $("#prompt").text(curQA.prompt);

    var wrongQAIdx = genRandomNotIn([correctQAIdx],data.length-1);
    var randomizedQAs = shuffle([correctQAIdx, wrongQAIdx]);
    
    $("#answerNumber0").text(data[randomizedQAs[0]].answer);
    $("#answerNumber2").text(data[randomizedQAs[1]].answer);
}

// show the given message
function showMessage(messageString) {
    $("#messages").text(messageString);
}

// show the change in score above the element with ID aboveId
function showScoreChange(scoreChange, isCorrect) {
    var color = "#c00";
    if(isCorrect) {
        color = "#0c4";
        scoreChange = "+"+scoreChange;
    }
    $("#scoreChange").fadeIn(500).text(scoreChange).css("color",color).fadeOut(300);
}

// @return an integer between 0 and @param max, inclusive
function genRandom(maxInt){
    return Math.floor(Math.random()*(maxInt+1));
}

// return int between 0 and maximum not in Array arr 
function genRandomNotIn(arr, maximum){
    var rand = genRandom(maximum);
    while(jQuery.inArray(rand,arr) != -1) {
        rand = genRandom(maximum);
    }
    return rand;
}

// handle score change
function changeScore(amount) {
    var curScore = parseInt($("#score").text());
    if ((curScore+amount)<0){
        curScore=0;
    }
    else {
        curScore += amount;
    }
    $("#score").text(curScore);
    
    // update highscore if necessary
    if(curScore > highscore) {
        highscore = curScore;
    }
}

// update the timer seconds by adding 1/10 second
function updateTimer() {
    // round to nearest 10th (precision problem)
    timerSeconds = Math.round((timerSeconds+0.1)*10)/10;
    if(timerSeconds == Math.round(timerSeconds)) {
        // add a '.0'
        $("#timer").text(timerSeconds+".0");
    }
    else {
        $("#timer").text(timerSeconds);
    }
}

// update the game status bar
function updateStatusBar() {
    var percentDone = correctQAIdxs.length/data.length;
    var newWidth = $("#statusbar").width() * percentDone;
    $("#currentstatus").css("width",newWidth+"px");
}

// check if user has won
function isWin(){
    if(correctQAIdxs.length >= data.length){
        // stop timer
        clearInterval(timer);
        
        // update best time if necessary
        if(timerSeconds < besttime) {
            besttime = timerSeconds;
        }
        
        // show game done and play again
        $("#messages").html("Game Done<br><span class='smaller'>High score: "+highscore+"</span><br><span class='smaller'>Best time: "+besttime+"</span>");
        $("#playAgain").show(200);
        return true;
    }
    return false;
}

/* 
Function to shuffle an array.
Author: Jonas Raoni Soares Silva, http://jsfromhell.com/array/shuffle [v1.0]
*/
shuffle = function(o){ //v1.0
    for(var j, x, i = o.length; i; j = parseInt(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
};
</script>
</body>
</html>
